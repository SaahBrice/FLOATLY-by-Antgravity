{% extends 'base.html' %}
{% load humanize %}

{% block title %}Report - {{ report.date }} | {{ kiosk.name }}{% endblock %}

{% block content %}
<div class="min-h-screen pb-24">
    
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-slate-900/90 backdrop-blur-xl border-b border-white/10">
        <div class="flex items-center justify-between px-4 py-3">
            <a href="{% url 'core:report_list' %}" class="p-2 text-white/70 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <div class="text-center">
                <h1 class="text-lg font-semibold text-white">{{ report.date|date:"M d, Y" }}</h1>
                <p class="text-white/50 text-xs">{{ kiosk.name }}</p>
            </div>
            {% if is_today %}
            <form method="post" action="{% url 'core:report_regenerate' date_str=report.date|date:'Y-m-d' %}?kiosk={{ kiosk.slug }}">
                {% csrf_token %}
                <button type="submit" class="p-2 text-white/70 hover:text-white" title="Refresh">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </form>
            {% else %}
            <div class="w-10"></div>
            {% endif %}
        </div>
    </header>
    
    <main class="p-4 max-w-lg mx-auto space-y-4">
        
        <!-- Low Balance Alerts -->
        {% if data.low_balance_alerts %}
        <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-red-400 text-xl">⚠️</span>
                <span class="text-red-400 font-semibold">Low Balance Alert</span>
            </div>
            <div class="space-y-1">
                {% for alert in data.low_balance_alerts %}
                <p class="text-red-300/80 text-sm">
                    <strong>{{ alert.network_name }}</strong>: {{ alert.balance|floatformat:0 }} CFA 
                    (below {{ alert.threshold|floatformat:0 }})
                </p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Main Stats -->
        <div class="grid grid-cols-2 gap-3">
            <!-- Total Profit -->
            <div class="col-span-2 p-5 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl">
                <p class="text-white/80 text-sm">Total Profit Today</p>
                <p class="text-white font-bold text-3xl mt-1">{{ data.total_profit|floatformat:0|intcomma }} <span class="text-lg font-normal">CFA</span></p>
                {% if data.vs_yesterday_percent != 0 %}
                <p class="text-white/70 text-sm mt-2">
                    {% if data.vs_yesterday_percent > 0 %}↑{% else %}↓{% endif %}
                    {{ data.vs_yesterday_percent|floatformat:1 }}% vs yesterday
                </p>
                {% endif %}
            </div>
            
            <!-- Cash Balance -->
            <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
                <p class="text-white/60 text-xs">Cash Balance</p>
                <p class="text-white font-bold text-xl">{{ data.cash_balance|floatformat:0|intcomma }}</p>
                {% if data.cash_days_remaining %}
                <p class="text-white/50 text-xs mt-1">~{{ data.cash_days_remaining }} days</p>
                {% endif %}
            </div>
            
            <!-- Float Balance -->
            <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
                <p class="text-white/60 text-xs">Float Balance</p>
                <p class="text-white font-bold text-xl">{{ data.float_balance|floatformat:0|intcomma }}</p>
                {% if data.float_days_remaining %}
                <p class="text-white/50 text-xs mt-1">~{{ data.float_days_remaining }} days</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Transaction Stats -->
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-3">Transactions</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-white">{{ data.transaction_count }}</p>
                    <p class="text-white/50 text-xs">Total</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-green-400">{{ data.deposit_count }}</p>
                    <p class="text-white/50 text-xs">Deposits</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-red-400">{{ data.withdrawal_count }}</p>
                    <p class="text-white/50 text-xs">Withdrawals</p>
                </div>
            </div>
            {% if data.avg_transaction_size > 0 %}
            <div class="mt-3 pt-3 border-t border-white/10">
                <div class="flex justify-between text-sm">
                    <span class="text-white/60">Average Size</span>
                    <span class="text-white">{{ data.avg_transaction_size|floatformat:0|intcomma }} CFA</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span class="text-white/60">Total Volume</span>
                    <span class="text-white">{{ data.total_volume|floatformat:0|intcomma }} CFA</span>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Weekly Comparison -->
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-3">Comparisons</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-white/60 text-sm">vs Yesterday</span>
                    <span class="{% if data.vs_yesterday_percent >= 0 %}text-green-400{% else %}text-red-400{% endif %} font-semibold">
                        {% if data.vs_yesterday_percent > 0 %}+{% endif %}{{ data.vs_yesterday_percent|floatformat:1 }}%
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-white/60 text-sm">vs Same Day Last Week</span>
                    <span class="{% if data.vs_last_week_percent >= 0 %}text-green-400{% else %}text-red-400{% endif %} font-semibold">
                        {% if data.vs_last_week_percent > 0 %}+{% endif %}{{ data.vs_last_week_percent|floatformat:1 }}%
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Float per Network -->
        {% if data.float_per_network %}
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-3">Float per Network</h3>
            <div class="space-y-2">
                {% for n in data.float_per_network %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: {{ n.network_color }};"></div>
                        <span class="text-white/80 text-sm">{{ n.network_name }}</span>
                    </div>
                    <span class="text-white font-medium">{{ n.balance|floatformat:0|intcomma }} CFA</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Network Distribution -->
        {% if data.network_distribution %}
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-3">Network Distribution</h3>
            <div class="space-y-2">
                {% for n in data.network_distribution %}
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-white/80">{{ n.network_name }}</span>
                        <span class="text-white/60">{{ n.count }} tx ({{ n.percentage }}%)</span>
                    </div>
                    <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full rounded-full" style="width: {{ n.percentage }}%; background-color: {{ n.network_color }};"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Busiest Hour -->
        {% if data.busiest_hour is not None %}
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-2">Busiest Hour</h3>
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">
                    <span class="text-amber-400 font-bold text-lg">{{ data.busiest_hour }}h</span>
                </div>
                <div>
                    <p class="text-white">{{ data.busiest_hour }}:00 - {{ data.busiest_hour|add:1 }}:00</p>
                    <p class="text-white/50 text-sm">{{ data.busiest_hour_count }} transactions</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Top Customers -->
        {% if data.top_customers %}
        <div class="p-4 bg-white/5 border border-white/10 rounded-xl">
            <h3 class="text-white font-semibold mb-3">Top Customers (This Week)</h3>
            <div class="space-y-3">
                {% for c in data.top_customers %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-primary-500/20 flex items-center justify-center text-primary-400 font-bold text-sm">
                            {{ forloop.counter }}
                        </div>
                        <div>
                            <p class="text-white text-sm">{{ c.phone }}</p>
                            <p class="text-white/50 text-xs">{{ c.transaction_count }} transactions</p>
                        </div>
                    </div>
                    <span class="text-white/80 font-medium">{{ c.total_amount|floatformat:0|intcomma }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Report metadata -->
        <div class="text-center text-white/40 text-xs pt-4">
            Generated: {{ data.generated_at|slice:":19" }}
        </div>
    </main>
</div>
{% endblock %}
