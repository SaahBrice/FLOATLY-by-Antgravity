<!DOCTYPE html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="description"
              content="Floatly - Digital logbook for mobile money agents in Cameroon">
        <meta name="theme-color" content="#1e40af">
        <!-- PWA Meta Tags -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="Floatly">
        <title>
            {% block title %}Floatly{% endblock %}
        </title>
        <!-- TailwindCSS via CDN (Development) - Replace with build in production -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        accent: {
                            50: '#fdf4ff',
                            100: '#fae8ff',
                            200: '#f5d0fe',
                            300: '#f0abfc',
                            400: '#e879f9',
                            500: '#d946ef',
                            600: '#c026d3',
                            700: '#a21caf',
                            800: '#86198f',
                            900: '#701a75',
                        },
                        momo: {
                            mtn: '#ffcc00',      /* MTN Yellow */
                            orange: '#ff6600',   /* Orange */
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
        </script>
        <!-- Google Fonts - Inter -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
              rel="stylesheet">
        <!-- HTMX -->
        <script src="https://unpkg.com/htmx.org@1.9.10"
                integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
                crossorigin="anonymous"></script>
        <!-- AlpineJS -->
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        
        <!-- Theme & i18n Initialization -->
        <script>
        // Initialize theme before Alpine loads (prevents flash)
        (function() {
            const theme = localStorage.getItem('floatly_theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
        
        // Alpine stores - initialized after Alpine loads
        document.addEventListener('alpine:init', () => {
            // Theme Store (dark/light mode)
            Alpine.store('theme', {
                mode: localStorage.getItem('floatly_theme') || 'dark',
                
                get isDark() { 
                    return this.mode === 'dark'; 
                },
                
                toggle() {
                    this.mode = this.mode === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('floatly_theme', this.mode);
                    document.documentElement.classList.toggle('dark', this.mode === 'dark');
                },
                
                set(mode) {
                    this.mode = mode;
                    localStorage.setItem('floatly_theme', mode);
                    document.documentElement.classList.toggle('dark', mode === 'dark');
                }
            });
            
            // i18n Store (French/English translations)
            Alpine.store('i18n', {
                lang: localStorage.getItem('floatly_lang') || 'fr',
                
                translations: {
                    // Navigation
                    nav_features: { en: 'Features', fr: 'Fonctionnalités' },
                    nav_pricing: { en: 'Pricing', fr: 'Tarifs' },
                    nav_login: { en: 'Log In', fr: 'Connexion' },
                    nav_signup: { en: 'Get Started', fr: 'Commencer' },
                    
                    // Hero
                    hero_title: { en: 'Track Your Float.', fr: 'Suivez Votre Float.' },
                    hero_title2: { en: 'Grow Your Business.', fr: 'Développez Votre Business.' },
                    hero_subtitle: { en: 'The digital logbook for mobile money agents in Cameroon', fr: 'Le carnet numérique pour les agents mobile money au Cameroun' },
                    hero_cta: { en: 'Start Free', fr: 'Commencer Gratuit' },
                    hero_cta2: { en: 'Watch Demo', fr: 'Voir la Démo' },
                    
                    // Features
                    features_title: { en: 'Built for Mobile Money Agents', fr: 'Conçu pour les Agents Mobile Money' },
                    features_subtitle: { en: 'Everything you need to manage your kiosk and track profits', fr: 'Tout ce dont vous avez besoin pour gérer votre kiosque et suivre vos profits' },
                    
                    feature1_title: { en: 'Auto Profit Calculator', fr: 'Calcul Automatique des Profits' },
                    feature1_desc: { en: 'Automatic commission calculation based on official rates', fr: 'Calcul automatique des commissions basé sur les tarifs officiels' },
                    
                    feature2_title: { en: 'Multi-Kiosk Management', fr: 'Gestion Multi-Kiosques' },
                    feature2_desc: { en: 'Manage multiple locations from one account', fr: 'Gérez plusieurs points de vente depuis un seul compte' },
                    
                    feature3_title: { en: 'Works Offline', fr: 'Fonctionne Hors Ligne' },
                    feature3_desc: { en: 'No internet? No problem. Sync when back online', fr: 'Pas d\'internet? Pas de problème. Synchronisez une fois en ligne' },
                    
                    feature4_title: { en: 'Team Access', fr: 'Accès Équipe' },
                    feature4_desc: { en: 'Invite cashiers with controlled permissions', fr: 'Invitez vos caissiers avec des permissions contrôlées' },
                    
                    // How it works
                    how_title: { en: 'How It Works', fr: 'Comment Ça Marche' },
                    step1_title: { en: 'Create Account', fr: 'Créer un Compte' },
                    step1_desc: { en: 'Sign up in 30 seconds', fr: 'Inscrivez-vous en 30 secondes' },
                    step2_title: { en: 'Add Transactions', fr: 'Ajouter des Transactions' },
                    step2_desc: { en: 'Log deposits & withdrawals', fr: 'Enregistrez dépôts et retraits' },
                    step3_title: { en: 'Track Profits', fr: 'Suivre les Profits' },
                    step3_desc: { en: 'See your earnings in real-time', fr: 'Voyez vos gains en temps réel' },
                    
                    // CTA
                    cta_title: { en: 'Ready to Simplify Your Business?', fr: 'Prêt à Simplifier Votre Business?' },
                    cta_subtitle: { en: 'Join hundreds of agents already using Floatly', fr: 'Rejoignez des centaines d\'agents qui utilisent déjà Floatly' },
                    cta_button: { en: 'Get Started Free', fr: 'Commencer Gratuitement' },
                    cta_login: { en: 'Already have an account?', fr: 'Déjà un compte?' },
                    
                    // Footer
                    footer_copyright: { en: '© 2024 Floatly. Built for Cameroon\'s mobile money agents.', fr: '© 2024 Floatly. Conçu pour les agents mobile money du Cameroun.' },
                    footer_privacy: { en: 'Privacy', fr: 'Confidentialité' },
                    footer_terms: { en: 'Terms', fr: 'Conditions' },
                    
                    // Pills
                    pill_mtn: { en: 'MTN MoMo', fr: 'MTN MoMo' },
                    pill_orange: { en: 'Orange Money', fr: 'Orange Money' },
                    pill_offline: { en: 'Works Offline', fr: 'Hors Ligne' },
                },
                
                t(key) {
                    const translation = this.translations[key];
                    if (!translation) return key;
                    return translation[this.lang] || translation['en'] || key;
                },
                
                setLang(lang) {
                    this.lang = lang;
                    localStorage.setItem('floatly_lang', lang);
                }
            });
        });
        </script>
        <!-- Custom Styles -->
        <style>
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Loading indicator for HTMX */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Pulse animation for notifications */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 1.5s ease-out infinite;
        }
        
        /* Slide transitions */
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        </style>
        {% block extra_css %}{% endblock %}
    </head>
    <body class="h-full bg-gradient-to-br from-slate-900 via-primary-900 to-slate-900 font-sans antialiased">
        <!-- HTMX Loading Indicator -->
        <div id="loading-indicator"
             class="htmx-indicator fixed top-0 left-0 right-0 z-50">
            <div class="h-1 bg-gradient-to-r from-primary-500 via-accent-500 to-primary-500 animate-pulse"></div>
        </div>
        <!-- Main Content -->
        <main id="main-content" class="min-h-full">
            {% block content %}{% endblock %}
        </main>
        <!-- Toast Notifications Container -->
        <div id="toast-container"
             class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"
             x-data="{ toasts: [] }"
             @toast.window="toasts.push($event.detail); setTimeout(() => toasts.shift(), 5000)">
            <template x-for="(toast, index) in toasts" :key="index">
                <div class="glass rounded-lg px-4 py-3 text-white shadow-xl slide-in"
                     :class="{ 'border-green-500': toast.type === 'success', 'border-red-500': toast.type === 'error', 'border-yellow-500': toast.type === 'warning', 'border-blue-500': toast.type === 'info' }">
                    <p x-text="toast.message" class="text-sm font-medium"></p>
                </div>
            </template>
        </div>
        {% block extra_js %}{% endblock %}
        <script>
        // HTMX configuration
        document.body.addEventListener('htmx:configRequest', function(evt) {
            // Add CSRF token to all requests
            evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
        
        // Show toast helper function
        function showToast(message, type = 'info') {
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message, type }
            }));
        }
        
        // Push notification support
        {% if user.is_authenticated %}
        (function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('[Push] Not supported');
                return;
            }
            
            // Register service worker and subscribe to push
            navigator.serviceWorker.register('/static/js/serviceworker.js')
                .then(async (registration) => {
                    console.log('[ServiceWorker] Registered');
                    
                    // Wait a bit for service worker to activate
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check notification permission
                    if (Notification.permission === 'granted') {
                        await subscribeToPush(registration);
                    } else if (Notification.permission !== 'denied') {
                        // Request permission
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            await subscribeToPush(registration);
                        }
                    }
                })
                .catch(err => console.error('[ServiceWorker] Error:', err));
            
            async function subscribeToPush(registration) {
                try {
                    // Check if already subscribed
                    let subscription = await registration.pushManager.getSubscription();
                    
                    if (!subscription) {
                        const vapidKey = '{{ VAPID_PUBLIC_KEY|default:"" }}';
                        if (!vapidKey) {
                            console.log('[Push] No VAPID key');
                            return;
                        }
                        
                        // Convert VAPID key
                        const padding = '='.repeat((4 - vapidKey.length % 4) % 4);
                        const base64 = (vapidKey + padding).replace(/-/g, '+').replace(/_/g, '/');
                        const rawData = window.atob(base64);
                        const applicationServerKey = new Uint8Array(rawData.length);
                        for (let i = 0; i < rawData.length; ++i) {
                            applicationServerKey[i] = rawData.charCodeAt(i);
                        }
                        
                        subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: applicationServerKey
                        });
                    }
                    
                    // Send to server
                    const response = await fetch('/api/push/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            endpoint: subscription.endpoint,
                            keys: {
                                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
                            }
                        })
                    });
                    
                    if (response.ok) {
                        console.log('[Push] Subscription registered');
                    }
                } catch (error) {
                    console.error('[Push] Error:', error);
                }
            }
        })();
        {% endif %}
        </script>
    </body>
</html>
