<!DOCTYPE html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="description"
              content="Floatly - Digital logbook for mobile money agents in Cameroon">
        <meta name="theme-color" content="#1e40af">
        <!-- PWA Meta Tags -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="Floatly">
        <title>
            {% block title %}Floatly{% endblock %}
        </title>
        <!-- TailwindCSS via CDN (Development) - Replace with build in production -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="/static/js/tailwind_config.js"></script>
        <!-- Google Fonts - Inter -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
              rel="stylesheet">
        <!-- HTMX -->
        <script src="https://unpkg.com/htmx.org@1.9.10"
                integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
                crossorigin="anonymous"></script>
        
        <!-- Alpine stores MUST load before Alpine.js (with defer) -->
        <script defer src="/static/js/alpine_stores.js"></script>
        <!-- AlpineJS (loads after stores due to defer order) -->
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        
        <!-- Chart.js for Dashboard Charts -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        
        <!-- Dashboard chart component -->
        <script src="/static/js/dashboard_chart.js"></script>
        <!-- Custom Styles -->
        <style>
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Loading indicator for HTMX */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Pulse animation for notifications */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 1.5s ease-out infinite;
        }
        
        /* Slide transitions */
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        </style>
        {% block extra_css %}{% endblock %}
    </head>
    <body class="h-full bg-gradient-to-br from-slate-900 via-primary-900 to-slate-900 font-sans antialiased">
        <!-- HTMX Loading Indicator -->
        <div id="loading-indicator"
             class="htmx-indicator fixed top-0 left-0 right-0 z-50">
            <div class="h-1 bg-gradient-to-r from-primary-500 via-accent-500 to-primary-500 animate-pulse"></div>
        </div>
        <!-- Main Content -->
        <main id="main-content" class="min-h-full">
            {% block content %}{% endblock %}
        </main>
        <!-- Toast Notifications Container -->
        <div id="toast-container"
             class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"
             x-data="{ toasts: [] }"
             @toast.window="toasts.push($event.detail); setTimeout(() => toasts.shift(), 5000)">
            <template x-for="(toast, index) in toasts" :key="index">
                <div class="glass rounded-lg px-4 py-3 text-white shadow-xl slide-in"
                     :class="{ 'border-green-500': toast.type === 'success', 'border-red-500': toast.type === 'error', 'border-yellow-500': toast.type === 'warning', 'border-blue-500': toast.type === 'info' }">
                    <p x-text="toast.message" class="text-sm font-medium"></p>
                </div>
            </template>
        </div>
        {% block extra_js %}{% endblock %}
        <script>
        // HTMX configuration
        document.body.addEventListener('htmx:configRequest', function(evt) {
            // Add CSRF token to all requests
            evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
        
        // Show toast helper function
        function showToast(message, type = 'info') {
            window.dispatchEvent(new CustomEvent('toast', {
                detail: { message, type }
            }));
        }
        
        // Push notification support
        {% if user.is_authenticated %}
        (function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('[Push] Not supported');
                return;
            }
            
            // Register service worker and subscribe to push
            navigator.serviceWorker.register('/static/js/serviceworker.js')
                .then(async (registration) => {
                    console.log('[ServiceWorker] Registered');
                    
                    // Wait a bit for service worker to activate
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check notification permission
                    if (Notification.permission === 'granted') {
                        await subscribeToPush(registration);
                    } else if (Notification.permission !== 'denied') {
                        // Request permission
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            await subscribeToPush(registration);
                        }
                    }
                })
                .catch(err => console.error('[ServiceWorker] Error:', err));
            
            async function subscribeToPush(registration) {
                try {
                    // Check if already subscribed
                    let subscription = await registration.pushManager.getSubscription();
                    
                    if (!subscription) {
                        const vapidKey = '{{ VAPID_PUBLIC_KEY|default:"" }}';
                        if (!vapidKey) {
                            console.log('[Push] No VAPID key');
                            return;
                        }
                        
                        // Convert VAPID key
                        const padding = '='.repeat((4 - vapidKey.length % 4) % 4);
                        const base64 = (vapidKey + padding).replace(/-/g, '+').replace(/_/g, '/');
                        const rawData = window.atob(base64);
                        const applicationServerKey = new Uint8Array(rawData.length);
                        for (let i = 0; i < rawData.length; ++i) {
                            applicationServerKey[i] = rawData.charCodeAt(i);
                        }
                        
                        subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: applicationServerKey
                        });
                    }
                    
                    // Send to server
                    const response = await fetch('/api/push/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            endpoint: subscription.endpoint,
                            keys: {
                                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
                            }
                        })
                    });
                    
                    if (response.ok) {
                        console.log('[Push] Subscription registered');
                    }
                } catch (error) {
                    console.error('[Push] Error:', error);
                }
            }
        })();
        {% endif %}
        </script>
    </body>
</html>
